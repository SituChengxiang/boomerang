# 这头昏脑涨的几天

## 老的物理模型——第一次模拟程序尝试
2026/01/26  

还是催一下自己吧。从晚上开始到2.1，能搞出点明堂吗


## 方向真的错了吗 —— 第二版物理模型
2026/01/27，28

卧槽，等等，输入的数据能量不守恒？

## 还是不要garbage in了？
2026/01/29  

重构项目结构+好了改一下滤波的算法

## 这下输入数据应该没啥问题了
2026/01/30

终于调好了

## 反推数据终于好一点了
2026/01/31

喜报 Cl和Cd终于没有暴涨了

## 第三次拟合程序构建
2026/02/01 

主要问题不在“参数没调好”，而在建模的自由度/变量选错了：你现在在用一个标量 φ 去“直接转动升力方向（或等价地让法向 n 围绕速度 v 转）”，但从第一性原理出发，力矩改变的是角动量向量 $\mathbf L$（也就是自转轴/刚体姿态），升力方向只是姿态 + 来流共同决定的“派生量”。把两者混成一个 φ，会在转向、面面角演化上必然出错（尤其你强调的“面面角先增大再减小”基本不可能自然出现）。

更具体地说：

- 进动方程用错对象：应当满足 $\dot{\mathbf L}=\boldsymbol\tau$，其中 $\mathbf L=I_z\,\omega\,\mathbf s$（$\mathbf s$ 为自转轴单位向量）。因此应积分的是 $\mathbf s$（或姿态），而不是把 $\Omega$ 直接塞成某个“绕 $\hat{\mathbf v}$ 的转角速度”。
- 你有了 $|\Omega|=\tau/(I\omega)$ 的标量，还缺最关键的“方向”：需要一个**力矩向量** $\boldsymbol\tau$（方向由几何/来流/升力分布决定），否则 $\mathbf s$ 往哪里进动只能靠猜；而“猜成绕速度转”通常会把航向角符号/曲率搞反或搞单调。
- 约束 n ⟂ v 的位置不对：$\mathbf F_L\perp\mathbf v$ 是对的，但“刚体法向/自转轴”不必然始终与 $\mathbf v$ 正交。正确结构应该是：先由姿态得到自转轴/机体法向 $\mathbf s$，再用投影得到升力方向 $\hat{\mathbf l}=\mathrm{norm}(\mathbf s-(\mathbf s\cdot\hat{\mathbf v})\hat{\mathbf v})$；你现在相当于把 $\hat{\mathbf l}$ 当状态量在转。

次要但会放大误差的点（在修正上述结构后再处理更划算）：
- 用 inverse solve 的常数 Cl/Cd 直接前推，会把强非定常段（尤其 knife-edge 段 Cd→0、Cl/Cd 随姿态/迎角变化）平均掉，导致高度/射程/转向强度系统性偏差。
- 用 $v_{eff}^2=v^2+(\sigma\omega a)^2$ 代替叶片积分是粗糙近似，会影响力和力矩的比例关系（也就影响你拟合出来的 D 的意义）。

如果你愿意我下一步直接动手改，optimizeParams.py 可以把状态改成自转轴 $\mathbf s$（3 维）+ 速度位置（6 维），用 $\dot{\mathbf s}=(\boldsymbol\tau-(\boldsymbol\tau\cdot\mathbf s)\mathbf s)/(I\omega)$，并把升力方向从 $\mathbf s$ 投影得到；这样“转向”和“面面角先增后减”才有物理空间出现。

## 再一次数据验证

图都很清晰，而且信息量足够做“非直觉”的判断。

你这几张图（PAHT,HRCt，PAT(-)，vzopt）给出的最重要结论有三个：

- 结论 A：两种 $a_{\perp,h}$ 估计（你现在的 $|v\times a|/|v|$ 和曲率法）在主峰位置、宽度、量级上基本一致  
  这几乎可以排除“低速除法 + 求导噪声”造成的假峰值。也就是说：横向向心加速度的峰值大概率是真实动力学信号，不是算法幻觉。

- 结论 B：航向角变化率一致性很好（$\dot\psi$ 与 $a_{\perp,h}/v_h$ 重合）  
  这说明“转弯”主要确实体现在“速度方向在旋转”，而且你当前对 $a_{\perp,h}$、$\psi$ 的计算是自洽的。也进一步说明：不需要（也不应该）在平动方程里硬塞一个“由力矩直接产生的 $\Omega\times v$ 偏转加速度”项——转弯应来自侧向合力。

- 结论 C：Pitch 在 $0.4\sim0.6$s 附近快速翻转，且这段时间正是 $v_h$ 低谷、$\dot\psi$ 峰值附近  
  这强烈暗示：关键机制是“姿态相关的气动力方向/分解发生了主导权切换”，而不是“tilt 没更新”（你的 tilt 已通过自旋轴状态隐式更新）。

基于这三点，我给你的建议是：下一步不要再纠结“测不到 $\omega$ 怎么办”或“要不要加额外偏转加速度”，而是做一个能直接回答模型结构问题的验证——用现有清洗数据反推出“需要什么样的侧向气动力”，看看它更像“盘翼升力投影”还是“自旋侧向力(Magnus类)”主导。

具体怎么做（都可以加到 VisualizeData.py 里，且不需要姿态测量）：

1) 用加速度直接反推出净气动力分量（这是第一性原理闭环）
- 已有 $a_x,a_y,a_z$，先算气动力（去掉重力）：
  $$
  \mathbf{F}_a = m\mathbf{a}-m\mathbf{g}
  $$
- 构造水平速度方向单位矢量 $\hat{\mathbf{t}}=\mathbf{v}_h/|\mathbf{v}_h|$，以及水平法向 $\hat{\mathbf{n}}=\hat{\mathbf{z}}\times\hat{\mathbf{t}}$（带符号决定“向内/向外”）。
- 然后投影得到三个最关键的可观测量：
  - 切向（类阻力/加速）：$F_t=\mathbf{F}_a\cdot\hat{\mathbf{t}}$
  - 水平法向（决定转弯）：$F_n=\mathbf{F}_a\cdot\hat{\mathbf{n}}$，对应 $a_{\perp,h}=F_n/m$
  - 竖直：$F_z=\mathbf{F}_a\cdot\hat{\mathbf{z}}$

这一步能把“转弯到底需要多大侧向力”定量钉死。

2) 计算“有效系数”随速度的形状，用来判别是否需要旋转修正项（σ/rot）
先用不带旋转修正的动压：
$$
q_0=\tfrac12\rho S |\mathbf{v}|^2
$$
定义
$$
C_{n,eff}=\frac{F_n}{q_0},\quad C_{z,eff}=\frac{F_z}{q_0},\quad C_{t,eff}=\frac{F_t}{q_0}
$$
如果你看到在 $v$ 变小的阶段，$C_{n,eff}$、$C_{z,eff}$ 离谱飙升（而不是缓慢变化），那就说明“仅靠 $v^2$ 的动压不够”，需要像你现在 ODE 里那样加入 $v_{rot}^2$（即 $v^2+(\sigma\omega A)^2$）来解释低速阶段仍然有显著气动力。

即使测不到 $\omega$，也可以用一个常数 $v_{rot}=k$ 做“等效旋转动压”验证：调 $k$ 让系数曲线在各轨迹上尽量变平/可复用，这就是对“σ项是否必要、量级多大”的数据证据。

3) 对比“峰值发生在低速”的真正物理含义
你已经验证了 $\dot\psi\approx a_{\perp,h}/v_h$。这告诉我们：低速时哪怕 $a_{\perp,h}$ 没变，$\dot\psi$ 也会变大；因此在讨论“顶点快速回旋”时，应更关注 $F_n$（或 $a_{\perp,h}$）到底有没有同时变大，而不是只看 $\dot\psi$。

你现在这组图里，$a_{\perp,h}$ 本身也确实出现峰值（好几条到 $6\sim9\,\text{m/s}^2$），所以这是“转弯率放大 + 侧向力增强”共同作用，不是单纯几何放大。

如果你点头，我可以继续修改 VisualizeData.py：把上面这套 $F_t,F_n,F_z$ 和 $C_{*,eff}$ 的曲线（以及一个“等效 $v_{rot}=k$ 扫描使系数最平”的小工具）加进去。这样我们就能用数据回答：低速阶段的强回旋到底是“需要旋转动压”还是“系数机制换挡（盘翼→自旋侧向）”。你希望先用哪一条轨迹做基准（track1 还是峰值更典型的那条）？

见到VisualizeData已经是很长很长一串了，然后好像有些功能又是实现过的，于是又开始了重构